# Configure Supervisor for Queue Workers
packages:
  yum:
    supervisor: []

files:
  "/etc/supervisord.d/laravel-worker.ini":
    mode: "000644"
    owner: root
    group: root
    content: |
      [program:laravel-worker]
      process_name=%(program_name)s_%(process_num)02d
      command=/usr/bin/php /var/app/current/artisan queue:work database --sleep=3 --tries=3 --max-time=3600
      autostart=true
      autorestart=true
      stopasgroup=true
      killasgroup=true
      user=webapp
      numprocs=2
      redirect_stderr=true
      stdout_logfile=/var/app/current/storage/logs/worker.log
      stopwaitsecs=3600

commands:
  01_enable_supervisor:
    command: "systemctl enable supervisord"
    
  02_start_supervisor:
    command: "systemctl start supervisord || systemctl restart supervisord"
    
  03_reread_supervisor:
    command: "supervisorctl reread"
    
  04_update_supervisor:
    command: "supervisorctl update"
    
  05_restart_workers:
    command: "supervisorctl restart laravel-worker:*"

